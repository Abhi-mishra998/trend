name: Setup AWS Credentials for GitHub Actions

on:
  workflow_dispatch:
    inputs:
      create_oidc_provider:
        description: "Create OIDC Provider for GitHub Actions"
        required: true
        default: true
        type: boolean
      create_iam_role:
        description: "Create IAM Role for GitHub Actions"
        required: true
        default: true
        type: boolean

jobs:
  setup:
    name: Setup AWS Credentials
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials (temporary)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-south-1

      - name: Create OIDC Provider
        if: ${{ inputs.create_oidc_provider }}
        run: |
          echo "ðŸ”§ Creating OIDC Provider for GitHub Actions..."

          # Check if OIDC provider already exists
          if aws iam list-open-id-connect-providers | grep -q "token.actions.githubusercontent.com"; then
            echo "âœ… OIDC Provider already exists"
          else
            # Create OIDC provider
            aws iam create-open-id-connect-provider \
              --url https://token.actions.githubusercontent.com \
              --thumbprint-list 6938fd4d98bab03faadb97b34396831e3780aea1 \
              --client-id-list sts.amazonaws.com

            echo "âœ… OIDC Provider created"
          fi

      - name: Create IAM Role
        if: ${{ inputs.create_iam_role }}
        run: |
          echo "ðŸ”§ Creating IAM Role for GitHub Actions..."

          # Get AWS account ID
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)

          # Create trust policy
          cat > trust-policy.json << EOF
          {
            "Version": "2012-10-17",
            "Statement": [
              {
                "Effect": "Allow",
                "Principal": {
                  "Federated": "arn:aws:iam::${ACCOUNT_ID}:oidc-provider/token.actions.githubusercontent.com"
                },
                "Action": "sts:AssumeRoleWithWebIdentity",
                "Condition": {
                  "StringEquals": {
                    "token.actions.githubusercontent.com:aud": "sts.amazonaws.com"
                  },
                  "StringLike": {
                    "token.actions.githubusercontent.com:sub": "repo:abhishek8056/trend:*"
                  }
                }
              }
            ]
          }
          EOF

          # Create the role
          aws iam create-role \
            --role-name GitHubActions-EKS-Deploy \
            --assume-role-policy-document file://trust-policy.json \
            --description "Role for GitHub Actions to deploy to EKS"

          # Attach the Load Balancer Controller policy
          aws iam attach-role-policy \
            --role-name GitHubActions-EKS-Deploy \
            --policy-arn arn:aws:iam::aws:policy/AmazonEKSLoadBalancerControllerPolicy

          # Attach additional permissions for EKS access
          aws iam attach-role-policy \
            --role-name GitHubActions-EKS-Deploy \
            --policy-arn arn:aws:iam::aws:policy/AmazonEKSClusterPolicy

          # Create custom policy for EKS operations
          cat > eks-deploy-policy.json << EOF
          {
            "Version": "2012-10-17",
            "Statement": [
              {
                "Effect": "Allow",
                "Action": [
                  "eks:DescribeCluster",
                  "eks:UpdateKubeconfig"
                ],
                "Resource": "arn:aws:eks:ap-south-1:${ACCOUNT_ID}:cluster/trend-app-eks-by-abhi"
              },
              {
                "Effect": "Allow",
                "Action": [
                  "ec2:DescribeSubnets",
                  "ec2:DescribeVpcs",
                  "ec2:DescribeSecurityGroups"
                ],
                "Resource": "*"
              }
            ]
          }
          EOF

          aws iam put-role-policy \
            --role-name GitHubActions-EKS-Deploy \
            --policy-name GitHubActions-EKS-Deploy-Policy \
            --policy-document file://eks-deploy-policy.json

          echo "âœ… IAM Role created: GitHubActions-EKS-Deploy"
          echo "ðŸ”— Role ARN: arn:aws:iam::${ACCOUNT_ID}:role/GitHubActions-EKS-Deploy"

      - name: Instructions
        run: |
          echo "ðŸ“‹ Next Steps:"
          echo ""
          echo "1. Add this secret to your GitHub repository:"
          echo "   AWS_ROLE_TO_ASSUME: arn:aws:iam::$(aws sts get-caller-identity --query Account --output text):role/GitHubActions-EKS-Deploy"
          echo ""
          echo "2. Remove the temporary AWS_ACCESS_KEY_ID and AWS_SECRET_ACCESS_KEY secrets"
          echo "   (since we're now using OIDC)"
          echo ""
          echo "3. Your deploy workflow will now use the IAM role instead of access keys"
