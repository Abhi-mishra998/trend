name: Kubernetes Validation

on:
  pull_request:
    paths:
      - "k8s/**"
  push:
    branches:
      - main
    paths:
      - "k8s/**"

jobs:
  validate:
    name: Validate Kubernetes Manifests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: "v1.31.0"

      - name: Validate YAML syntax
        run: |
          echo "üîç Validating YAML syntax with kubectl..."
          for file in k8s/*.yaml; do
            echo "üìÑ Checking $file"
            if kubectl apply --dry-run=client -f "$file"; then
              echo "‚úÖ $file is valid"
            else
              echo "‚ùå $file has syntax errors"
              exit 1
            fi
          done

      - name: Install kubeval
        run: |
          echo "üì¶ Installing kubeval..."
          wget -q https://github.com/instrumenta/kubeval/releases/latest/download/kubeval-linux-amd64.tar.gz
          tar xf kubeval-linux-amd64.tar.gz
          sudo mv kubeval /usr/local/bin
          kubeval --version

      - name: Run kubeval
        run: |
          echo "üîç Running kubeval validation..."
          for file in k8s/*.yaml; do
            echo "üìÑ Validating $file with kubeval"
            if kubeval "$file" --kubernetes-version 1.31.0 --strict --ignore-missing-schemas; then
              echo "‚úÖ $file passed kubeval validation"
            else
              echo "‚ùå $file failed kubeval validation"
              exit 1
            fi
          done

      - name: Validate resource limits
        run: |
          echo "üìä Checking resource limits and requests..."
          for file in k8s/*.yaml; do
            if grep -q "kind: Deployment" "$file"; then
              echo "üîç Checking resources in $file"
              # Check if containers have resource limits
              if ! kubectl get -f "$file" -o jsonpath='{.spec.template.spec.containers[*].resources}' 2>/dev/null | grep -q "limits\|requests"; then
                echo "‚ö†Ô∏è  Warning: No resource limits/requests found in $file"
              else
                echo "‚úÖ Resource limits/requests found in $file"
              fi
            fi
          done
