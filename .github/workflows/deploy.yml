name: Deploy to EKS

on:
  push:
    branches:
      - main
    paths:
      - "k8s/**"
      - "Dockerfile"
      - "package.json"
      - "src/**"
      - "public/**"

jobs:
  deploy:
    name: Deploy to EKS
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-south-1
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          role-session-name: GitHubActions-EKS-Deploy

      - name: Setup kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: "v1.31.0"

      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig --region ap-south-1 --name trend-app-eks-by-abhi

      - name: Verify cluster connection
        run: |
          kubectl cluster-info
          kubectl get nodes

      - name: Deploy to Kubernetes
        run: |
          echo "üöÄ Deploying to Kubernetes..."

          # Create namespace if it doesn't exist
          kubectl create namespace trend-app --dry-run=client -o yaml | kubectl apply -f -

          # Apply all Kubernetes manifests
          kubectl apply -f k8s/

          # Wait for deployment rollout
          echo "‚è≥ Waiting for deployment to roll out..."
          kubectl rollout status deployment/trend-app-deployment -n trend-app --timeout=600s

          # Wait for pods to be ready
          kubectl wait --for=condition=ready pod -l app=trend-app -n trend-app --timeout=300s

      - name: Verify deployment
        run: |
          echo "üîç Verifying deployment..."

          # Check pods
          echo "üìä Pod status:"
          kubectl get pods -n trend-app

          # Check services
          echo "üåê Service status:"
          kubectl get svc -n trend-app

          # Get LoadBalancer URL
          LB_URL=$(kubectl get svc trend-app-service -n trend-app -o jsonpath='{.status.loadBalancer.ingress[0].hostname}' 2>/dev/null || echo "pending")

          if [ "$LB_URL" != "pending" ] && [ -n "$LB_URL" ]; then
            echo "‚úÖ LoadBalancer URL: http://$LB_URL"
            echo "ü©∫ Testing health check..."
            # Test the health endpoint
            if curl -f -m 30 http://$LB_URL/; then
              echo "‚úÖ Application is responding!"
            else
              echo "‚ùå Application health check failed"
              kubectl logs -l app=trend-app -n trend-app --tail=50
              exit 1
            fi
          else
            echo "‚è≥ LoadBalancer still provisioning..."
            echo "üìù Check status manually: kubectl get svc -n trend-app"
          fi

      - name: Cleanup old resources (optional)
        run: |
          echo "üßπ Cleaning up old resources..."
          # Remove completed jobs (if any)
          kubectl delete jobs --field-selector status.successful=1 -n trend-app || true
